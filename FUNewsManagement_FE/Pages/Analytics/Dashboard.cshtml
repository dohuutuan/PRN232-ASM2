@page
@model FUNewsManagement_FE.Pages.Analytics.DashboardModel
@{
    ViewData["Title"] = "Analytics Dashboard";
}

<div class="container mt-4">
    <h2 class="mb-3 text-center">📊 Phân tích bài viết</h2>

    <!-- Bộ lọc -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-3">
            <label class="form-label">Từ ngày</label>
            <input type="date" asp-for="StartDate" class="form-control" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Đến ngày</label>
            <input type="date" asp-for="EndDate" class="form-control" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Danh mục</label>
            <input type="text" asp-for="Category" class="form-control" placeholder="VD: Thời sự" />
        </div>
        <div class="col-md-2">
            <label class="form-label">Trạng thái</label>
            <select asp-for="Status" class="form-select">
                <option value="">Tất cả</option>
                <option value="Published">Đã đăng</option>
                <option value="Draft">Nháp</option>
                <option value="Pending">Chờ duyệt</option>
            </select>
        </div>
        <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Lọc</button>
        </div>
    </form>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }
    else if (Model.AnalyticsData != null)
    {
        <div class="row mb-4">
            <div class="col-md-6">
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="authorChart"></canvas>
            </div>
        </div>

        <div class="text-end">
            <a asp-page-handler="Export" class="btn btn-success">
                📥 Xuất Excel
            </a>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script> <!-- Plugin hiển thị nhãn -->
    @if (Model.AnalyticsData != null)
    {
        <script>
            const categoryData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AnalyticsData.CategoryStats));
            const authorData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AnalyticsData.AuthorStats));

            // --- Biểu đồ Pie (Danh mục) ---
            const ctx1 = document.getElementById('categoryChart');
            new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        label: 'Bài viết theo danh mục',
                        data: Object.values(categoryData),
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value, ctx) => {
                                const data = ctx.chart.data.datasets[0].data;
                                const total = data.reduce((a, b) => a + b, 0);
                                const percent = (value / total * 100).toFixed(1);
                                return percent + '%'; // ✅ Hiển thị phần trăm
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // --- Biểu đồ Bar (Tác giả) ---
            const ctx2 = document.getElementById('authorChart');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(authorData),
                    datasets: [{
                        label: 'Bài viết theo tác giả',
                        data: Object.values(authorData),
                        borderWidth: 1,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#333',
                            anchor: 'end',
                            align: 'top',
                            font: { weight: 'bold' },
                            formatter: (value) => value // ✅ Giữ hiển thị số
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        </script>
    }
}

